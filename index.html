<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#2563eb', accent: '#1d4ed8' }
        }
      }
    }
  </script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-lg transition-all duration-300">
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">
      üí≥ Payment Portal
    </h1>

    <div class="space-y-5">
      <!-- Email -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Customer Email</label>
        <input id="email" type="email" placeholder="customer@example.com"
          class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition"/>
      </div>

      <!-- Payment Method -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
        <select id="paymentType"
          class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
          <option value="card">üí≥ Credit / Debit Card</option>
          <option value="us_bank_account">üè¶ Bank Account (ACH)</option>
        </select>
      </div>

      <!-- Payment Mode -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Type</label>
        <select id="paymentMode"
          class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
          <option value="one_time">üí∞ One-Time Payment</option>
          <option value="subscription">üîÅ Subscription</option>
        </select>
      </div>

      <!-- Amount -->
      <div id="amountSection">
        <label class="block text-sm font-medium text-gray-700 mb-1">Amount (in cents)</label>
        <input id="amount" type="number" min="1" placeholder="e.g. 2000 for $20.00"
          class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition"/>
      </div>

      <!-- Price ID for Subscriptions -->
      <div id="priceSection" class="hidden">
        <label class="block text-sm font-medium text-gray-700 mb-2">Select Plan</label>
        <div class="grid grid-cols-2 gap-3">
          <button class="plan-btn border rounded-lg p-3 hover:bg-blue-50 transition" data-price="price_monthly">
            <p class="font-semibold text-gray-800">Monthly</p>
            <p class="text-sm text-gray-500">$10 / month</p>
          </button>
          <button class="plan-btn border rounded-lg p-3 hover:bg-blue-50 transition" data-price="price_yearly">
            <p class="font-semibold text-gray-800">Annual</p>
            <p class="text-sm text-gray-500">$100 / year</p>
          </button>
        </div>
        <input type="hidden" id="priceId" />
      </div>

      <!-- Reference -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Reference (optional)</label>
        <input id="ref" type="text" placeholder="Internal note or invoice ref"
          class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition"/>
      </div>

      <!-- Submit Button -->
      <button id="processBtn"
        class="w-full bg-primary hover:bg-accent text-white rounded-lg p-3 font-semibold flex items-center justify-center gap-2 transition disabled:opacity-50 disabled:cursor-not-allowed">
        <span id="btnText">Process Payment</span>
        <svg id="loadingIcon" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
      </button>

      <!-- Result -->
      <div id="result" class="text-center text-sm mt-4"></div>
    </div>
  </div>

  <script>
    const amountSection = document.getElementById("amountSection");
    const priceSection = document.getElementById("priceSection");
    const paymentMode = document.getElementById("paymentMode");
    const processBtn = document.getElementById("processBtn");
    const result = document.getElementById("result");
    const loadingIcon = document.getElementById("loadingIcon");
    const btnText = document.getElementById("btnText");

    const planButtons = document.querySelectorAll(".plan-btn");
    const priceInput = document.getElementById("priceId");

    // Switch between one-time and subscription UI
    paymentMode.addEventListener("change", () => {
      if (paymentMode.value === "subscription") {
        amountSection.classList.add("hidden");
        priceSection.classList.remove("hidden");
      } else {
        amountSection.classList.remove("hidden");
        priceSection.classList.add("hidden");
      }
    });

    // Select plan
    planButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        planButtons.forEach(b => b.classList.remove("ring-2", "ring-primary", "bg-blue-50"));
        btn.classList.add("ring-2", "ring-primary", "bg-blue-50");
        priceInput.value = btn.dataset.price;
      });
    });

    // Handle payment
    processBtn.addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const paymentType = document.getElementById("paymentType").value;
      const mode = paymentMode.value;
      const amount = document.getElementById("amount").value;
      const priceId = priceInput.value;
      const ref = document.getElementById("ref").value.trim();

      result.innerHTML = "";
      if (!email) {
        result.innerHTML = `<p class="text-red-600">‚ö†Ô∏è Please enter an email address.</p>`;
        return;
      }

      processBtn.disabled = true;
      loadingIcon.classList.remove("hidden");
      btnText.textContent = "Processing...";

      try {
        let endpoint, body;

        if (mode === "subscription") {
          if (!priceId) {
            result.innerHTML = `<p class="text-red-600">‚ö†Ô∏è Please select a subscription plan.</p>`;
            return;
          }
          endpoint = "/create-subscription";
          body = { email, priceId, paymentMethodType: paymentType, ref };
        } else {
          if (!amount || amount <= 0) {
            result.innerHTML = `<p class="text-red-600">‚ö†Ô∏è Please enter a valid amount.</p>`;
            return;
          }
          endpoint = "/create-payment-intent";
          body = { email, amount: parseInt(amount), currency: "usd", ref };
        }

        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json();
        if (data.error) {
          result.innerHTML = `<p class="text-red-600">‚ùå ${data.error}</p>`;
        } else {
          result.innerHTML = `
            <p class="text-green-600 font-semibold">‚úÖ ${mode === "subscription" ? "Subscription Created!" : "Payment Created!"}</p>
            <p><b>Ref:</b> ${ref || "(none)"}</p>
            ${data.subscriptionId ? `<p><b>Subscription ID:</b> ${data.subscriptionId}</p>` : ""}
            ${data.status ? `<p><b>Status:</b> ${data.status}</p>` : ""}
          `;
        }
      } catch (err) {
        console.error(err);
        result.innerHTML = `<p class="text-red-600">‚ö†Ô∏è Network or server error.</p>`;
      } finally {
        processBtn.disabled = false;
        loadingIcon.classList.add("hidden");
        btnText.textContent = "Process Payment";
      }
    });
  </script>
</body>
</html>
